% TODO : CLEAN UP THIS MESS
% (AND MAKE SURE ALL TEXTS STILL COMPILE)
\usepackage[leqno]{amsmath}
\usepackage{amssymb}
\usepackage{graphicx}

\usepackage{diagbox} % table heads with diagonal lines
\usepackage{relsize}

\usepackage{wasysym}
\usepackage{scrextend}
\usepackage{epigraph}
\setlength\epigraphwidth{.6\textwidth}

\usepackage[utf8]{inputenc}

\usepackage{titlesec}
\titleformat{\chapter}[display]
  {\normalfont\sffamily\huge\bfseries}
  {\chaptertitlename\ \thechapter}{5pt}{\Huge}
\titleformat{\section}
  {\normalfont\sffamily\Large\bfseries}
  {\thesection}{1em}{}
\titleformat{\subsection}
  {\normalfont\sffamily\large\bfseries}
  {\thesubsection}{1em}{}
\titleformat{\part}[display]
  {\normalfont\sffamily\huge\bfseries}
  {\partname\ \thepart}{0pt}{\Huge}

\usepackage[T1]{fontenc}
\usepackage{fourier}
\usepackage{paratype}

\usepackage[symbol,perpage]{footmisc}

\usepackage{perpage}
\MakePerPage{footnote}

\usepackage{array}
\newcolumntype{x}[1]{>{\centering\hspace{0pt}}p{#1}}

% TODO: the following line causes conflict with new texlive (!)
% \usepackage[english,russian,polutonikogreek,spanish]{babel}
% \newcommand{\russian}[1]{{\selectlanguage{russian}#1}}

% Remove conflicting options for the moment:
\usepackage[english,polutonikogreek,spanish]{babel}

\AtBeginDocument{\shorthandoff{"}}
\newcommand{\greek}[1]{{\selectlanguage{polutonikogreek}#1}}

% % % % % % % % % % % % % % % % % % % % % % % % % % % % % %
% Limit/colimit symbols (with accented i: lím / colím)

\usepackage{etoolbox} % \patchcmd

\makeatletter
\patchcmd{\varlim@}{lim}{\lim}{}{}
\makeatother
\DeclareMathOperator*{\colim}{co{\lim}}
\newcommand{\dirlim}{\varinjlim}
\newcommand{\invlim}{\varprojlim}

% % % % % % % % % % % % % % % % % % % % % % % % % % % % % %

\usepackage[all,color]{xy}

\usepackage{pigpen}
\newcommand{\po}{\ar@{}[dr]|(.4){\text{\pigpenfont I}}}
\newcommand{\pb}{\ar@{}[dr]|(.3){\text{\pigpenfont A}}}
\newcommand{\polr}{\ar@{}[dr]|(.65){\text{\pigpenfont A}}}
\newcommand{\pour}{\ar@{}[ur]|(.65){\text{\pigpenfont G}}}
\newcommand{\hstar}{\mathop{\bigstar}}

\newcommand{\bigast}{\mathop{\Huge \mathlarger{\mathlarger{\ast}}}}

\newcommand{\term}{\textbf}

\usepackage{stmaryrd}

\usepackage{cancel}

\usepackage{tikzsymbols}

\newcommand{\open}{\underset{\mathrm{open}}{\hookrightarrow}}
\newcommand{\closed}{\underset{\mathrm{closed}}{\hookrightarrow}}

\newcommand{\tcol}[2]{{#1 \choose #2}}

\newcommand{\homot}{\simeq}
\newcommand{\isom}{\cong}
\newcommand{\cH}{\mathcal{H}}
\renewcommand{\hom}{\mathrm{hom}}
\renewcommand{\div}{\mathop{\mathrm{div}}}
\renewcommand{\Im}{\mathop{\mathrm{Im}}}
\renewcommand{\Re}{\mathop{\mathrm{Re}}}
\newcommand{\id}[1]{\mathrm{id}_{#1}}
\newcommand{\idid}{\mathrm{id}}

\newcommand{\ZG}{{\ZZ G}}
\newcommand{\ZH}{{\ZZ H}}

\newcommand{\quiso}{\simeq}

\newcommand{\personality}[1]{{\sc #1}}

\newcommand{\mono}{\rightarrowtail}
\newcommand{\epi}{\twoheadrightarrow}
\newcommand{\xepi}[1]{\xrightarrow{#1}\mathrel{\mkern-14mu}\rightarrow}

% % % % % % % % % % % % % % % % % % % % % % % % % % % % % %

\DeclareMathOperator{\Ad}{Ad}
\DeclareMathOperator{\Aff}{Aff}
\DeclareMathOperator{\Ann}{Ann}
\DeclareMathOperator{\Aut}{Aut}
\DeclareMathOperator{\Br}{Br}
\DeclareMathOperator{\CH}{CH}
\DeclareMathOperator{\Cl}{Cl}
\DeclareMathOperator{\Coeq}{Coeq}
\DeclareMathOperator{\Coind}{Coind}
\DeclareMathOperator{\Cop}{Cop}
\DeclareMathOperator{\Corr}{Corr}
\DeclareMathOperator{\Cor}{Cor}
\DeclareMathOperator{\Cov}{Cov}
\DeclareMathOperator{\Der}{Der}
\DeclareMathOperator{\Div}{Div}
\DeclareMathOperator{\D}{D}
\DeclareMathOperator{\Ehr}{Ehr}
\DeclareMathOperator{\End}{End}
\DeclareMathOperator{\Eq}{Eq}
\DeclareMathOperator{\Ext}{Ext}
\DeclareMathOperator{\Frac}{Frac}
\DeclareMathOperator{\Frob}{Frob}
\DeclareMathOperator{\Funct}{Funct}
\DeclareMathOperator{\Fun}{Fun}
\DeclareMathOperator{\GL}{GL}
\DeclareMathOperator{\Gal}{Gal}
\DeclareMathOperator{\Gr}{Gr}
\DeclareMathOperator{\Hol}{Hol}
\DeclareMathOperator{\Hom}{Hom}
\DeclareMathOperator{\Ho}{Ho}
\DeclareMathOperator{\Id}{Id}
\DeclareMathOperator{\Ind}{Ind}
\DeclareMathOperator{\Inn}{Inn}
\DeclareMathOperator{\Isom}{Isom}
\DeclareMathOperator{\Ker}{Ker}
\DeclareMathOperator{\Lan}{Lan}
\DeclareMathOperator{\Lie}{Lie}
\DeclareMathOperator{\Map}{Map}
\DeclareMathOperator{\Mat}{Mat}
\DeclareMathOperator{\Max}{Max}
\DeclareMathOperator{\Mor}{Mor}
\DeclareMathOperator{\Nat}{Nat}
\DeclareMathOperator{\Nrd}{Nrd}
\DeclareMathOperator{\Ob}{Ob}
\DeclareMathOperator{\Out}{Out}
\DeclareMathOperator{\PGL}{PGL}
\DeclareMathOperator{\PSL}{PSL}
\DeclareMathOperator{\PSU}{PSU}
\DeclareMathOperator{\Pic}{Pic}
\DeclareMathOperator{\RHom}{RHom}
\DeclareMathOperator{\Rad}{Rad}
\DeclareMathOperator{\Ran}{Ran}
\DeclareMathOperator{\Rep}{Rep}
\DeclareMathOperator{\Res}{Res}
\DeclareMathOperator{\SL}{SL}
\DeclareMathOperator{\SO}{SO}
\DeclareMathOperator{\SU}{SU}
\DeclareMathOperator{\Sh}{Sh}
\DeclareMathOperator{\Sing}{Sing}
\DeclareMathOperator{\Specm}{Specm}
\DeclareMathOperator{\Spec}{Spec}
\DeclareMathOperator{\Sp}{Sp}
\DeclareMathOperator{\Stab}{Stab}
\DeclareMathOperator{\Sym}{Sym}
\DeclareMathOperator{\Tors}{Tors}
\DeclareMathOperator{\Tor}{Tor}
\DeclareMathOperator{\Tot}{Tot}
\DeclareMathOperator{\UUU}{U}

\DeclareMathOperator{\adj}{adj}
\DeclareMathOperator{\ad}{ad}
\DeclareMathOperator{\af}{af}
\DeclareMathOperator{\card}{card}
\DeclareMathOperator{\cm}{cm}
\DeclareMathOperator{\codim}{codim}
\DeclareMathOperator{\cod}{cod}
\DeclareMathOperator{\coeq}{coeq}
\DeclareMathOperator{\coim}{coim}
\DeclareMathOperator{\coker}{coker}
\DeclareMathOperator{\cont}{cont}
\DeclareMathOperator{\conv}{conv}
\DeclareMathOperator{\cor}{cor}
\DeclareMathOperator{\depth}{depth}
\DeclareMathOperator{\diag}{diag}
\DeclareMathOperator{\diam}{diam}
\DeclareMathOperator{\dist}{dist}
\DeclareMathOperator{\dom}{dom}
\DeclareMathOperator{\eq}{eq}
\DeclareMathOperator{\ev}{ev}
\DeclareMathOperator{\ex}{ex}
\DeclareMathOperator{\fchar}{char}
\DeclareMathOperator{\fr}{fr}
\DeclareMathOperator{\gr}{gr}
\DeclareMathOperator{\im}{im}
\DeclareMathOperator{\infl}{inf}
\DeclareMathOperator{\interior}{int}
\DeclareMathOperator{\intrel}{intrel}
\DeclareMathOperator{\inv}{inv}
\DeclareMathOperator{\length}{length}
\DeclareMathOperator{\mcd}{mcd}
\DeclareMathOperator{\mcm}{mcm}
\DeclareMathOperator{\multideg}{multideg}
\DeclareMathOperator{\ord}{ord}
\DeclareMathOperator{\pr}{pr}
\DeclareMathOperator{\rel}{rel}
\DeclareMathOperator{\res}{res}
\DeclareMathOperator{\rkred}{rkred}
\DeclareMathOperator{\rkss}{rkss}
\DeclareMathOperator{\rk}{rk}
\DeclareMathOperator{\sgn}{sgn}
\DeclareMathOperator{\sk}{sk}
\DeclareMathOperator{\supp}{supp}
\DeclareMathOperator{\trdeg}{trdeg}
\DeclareMathOperator{\tr}{tr}
\DeclareMathOperator{\vol}{vol}

\newcommand{\iHom}{\underline{\Hom}}

\renewcommand{\AA}{\mathbb{A}}
\newcommand{\CC}{\mathbb{C}}
\renewcommand{\SS}{\mathbb{S}}
\newcommand{\TT}{\mathbb{T}}
\newcommand{\PP}{\mathbb{P}}
\newcommand{\BB}{\mathbb{B}}
\newcommand{\RR}{\mathbb{R}}
\newcommand{\ZZ}{\mathbb{Z}}
\newcommand{\FF}{\mathbb{F}}
\newcommand{\HH}{\mathbb{H}}
\newcommand{\NN}{\mathbb{N}}
\newcommand{\QQ}{\mathbb{Q}}
\newcommand{\KK}{\mathbb{K}}

% % % % % % % % % % % % % % % % % % % % % % % % % % % % % %

\usepackage{amsthm}

\newcommand{\legendre}[2]{\left(\frac{#1}{#2}\right)}

\newcommand{\examplesymbol}{$\blacktriangle$}
\renewcommand{\qedsymbol}{$\blacksquare$}

\newcommand{\dfn}{\mathrel{\mathop:}=}
\newcommand{\rdfn}{=\mathrel{\mathop:}}

\usepackage{xcolor}
\definecolor{mylinkcolor}{rgb}{0.0,0.4,1.0}
\definecolor{mycitecolor}{rgb}{0.0,0.4,1.0}
\definecolor{shadecolor}{rgb}{0.79,0.78,0.65}
\definecolor{gray}{rgb}{0.6,0.6,0.6}

\usepackage{colortbl}

\definecolor{myred}{rgb}{0.7,0.0,0.0}
\definecolor{mygreen}{rgb}{0.0,0.7,0.0}
\definecolor{myblue}{rgb}{0.0,0.0,0.7}

\definecolor{redshade}{rgb}{0.9,0.5,0.5}
\definecolor{greenshade}{rgb}{0.5,0.9,0.5}

\usepackage[unicode,colorlinks=true,linkcolor=mylinkcolor,citecolor=mycitecolor]{hyperref}
\newcommand{\refref}[2]{\hyperref[#2]{#1~\ref*{#2}}}
\newcommand{\eqnref}[1]{\hyperref[#1]{(\ref*{#1})}}

\newcommand{\tos}{\!\!\to\!\!}

\usepackage{framed}

\newcommand{\cequiv}{\simeq}

\makeatletter
\newcommand\xleftrightarrow[2][]{%
  \ext@arrow 9999{\longleftrightarrowfill@}{#1}{#2}}
\newcommand\longleftrightarrowfill@{%
  \arrowfill@\leftarrow\relbar\rightarrow}
\makeatother

\newcommand{\bsquare}{\textrm{\ding{114}}}

% % % % % % % % % % % % % % % % % % % % % % % % % % % % % %

\newtheoremstyle{myplain}
  {\topsep}   % ABOVESPACE
  {\topsep}   % BELOWSPACE
  {\itshape}  % BODYFONT
  {0pt}       % INDENT (empty value is the same as 0pt)
  {\bfseries} % HEADFONT
  {.}         % HEADPUNCT
  {5pt plus 1pt minus 1pt} % HEADSPACE
  {\thmnumber{#2}. \thmname{#1}\thmnote{ (#3)}}   % CUSTOM-HEAD-SPEC

\newtheoremstyle{myplainnameless}
  {\topsep}   % ABOVESPACE
  {\topsep}   % BELOWSPACE
  {\normalfont}  % BODYFONT
  {0pt}       % INDENT (empty value is the same as 0pt)
  {\bfseries} % HEADFONT
  {.}         % HEADPUNCT
  {5pt plus 1pt minus 1pt} % HEADSPACE
  {\thmnumber{#2}}   % CUSTOM-HEAD-SPEC 

\newtheoremstyle{sectionexercise}
  {\topsep}   % ABOVESPACE
  {\topsep}   % BELOWSPACE
  {\normalfont}  % BODYFONT
  {0pt}       % INDENT (empty value is the same as 0pt)
  {\bfseries} % HEADFONT
  {.}         % HEADPUNCT
  {5pt plus 1pt minus 1pt} % HEADSPACE
  {Ejercicio \thmnumber{#2}\thmnote{ (#3)}}   % CUSTOM-HEAD-SPEC

\newtheoremstyle{mydefinition}
  {\topsep}   % ABOVESPACE
  {\topsep}   % BELOWSPACE
  {\normalfont}  % BODYFONT
  {0pt}       % INDENT (empty value is the same as 0pt)
  {\bfseries} % HEADFONT
  {.}         % HEADPUNCT
  {5pt plus 1pt minus 1pt} % HEADSPACE
  {\thmnumber{#2}. \thmname{#1}\thmnote{ (#3)}}   % CUSTOM-HEAD-SPEC

% EN ESPAÑOL

\newtheorem*{hecho*}{Hecho}
\newtheorem*{corolario*}{Corolario}
\newtheorem*{teorema*}{Teorema}
\newtheorem*{conjetura*}{Conjetura}
\newtheorem*{proyecto*}{Proyecto}
\newtheorem*{observacion*}{Observación}

\newtheorem*{lema*}{Lema}
\newtheorem*{resultado-clave*}{Resultado clave}
\newtheorem*{proposicion*}{Proposición}

\theoremstyle{definition}
\newtheorem*{ejercicio*}{Ejercicio}
\newtheorem*{definicion*}{Definición}
\newtheorem*{comentario*}{Comentario}
\newtheorem*{definicion-alternativa*}{Definición alternativa}
\newtheorem*{ejemploxs}{Ejemplo}
\newenvironment{ejemplo*}
  {\pushQED{\qed}\renewcommand{\qedsymbol}{\examplesymbol}\ejemploxs}
  {\popQED\endejemploxs}

\theoremstyle{myplain}
\newtheorem{proposicion}{Proposición}[section]

\newtheorem{proyecto}[proposicion]{Proyecto}
\newtheorem{teorema}[proposicion]{Teorema}
\newtheorem{corolario}[proposicion]{Corolario}
\newtheorem{hecho}[proposicion]{Hecho}
\newtheorem{lema}[proposicion]{Lema}

\newtheorem{observacion}[proposicion]{Observación}

\newenvironment{observacionejerc}
    {\pushQED{\qed}\renewcommand{\qedsymbol}{$\square$}\csname inner@observacionejerc\endcsname}
    {\popQED\csname endinner@observacionejerc\endcsname}
\newtheorem{inner@observacionejerc}[proposicion]{Observación}

\newenvironment{proposicionejerc}
    {\pushQED{\qed}\renewcommand{\qedsymbol}{$\square$}\csname inner@proposicionejerc\endcsname}
    {\popQED\csname endinner@proposicionejerc\endcsname}
\newtheorem{inner@proposicionejerc}[proposicion]{Proposicion}

\newenvironment{lemaejerc}
    {\pushQED{\qed}\renewcommand{\qedsymbol}{$\square$}\csname inner@lemaejerc\endcsname}
    {\popQED\csname endinner@lemaejerc\endcsname}
\newtheorem{inner@lemaejerc}[proposicion]{Lema}

\newtheorem{calculo}[proposicion]{Cálculo}

\theoremstyle{myplainnameless}
\newtheorem{nameless}[proposicion]{}

\theoremstyle{mydefinition}
\newtheorem{comentario}[proposicion]{Comentario}
\newtheorem{comentarioast}[proposicion]{Comentario ($\clubsuit$)}
\newtheorem{construccion}[proposicion]{Construcción}
\newtheorem{aplicacion}[proposicion]{Aplicación}
\newtheorem{definicion}[proposicion]{Definición}
\newtheorem{definicion-alternativa}[proposicion]{Definición alternativa}
\newtheorem{notacion}[proposicion]{Notación}
\newtheorem{advertencia}[proposicion]{Advertencia}
\newtheorem{digresion}[proposicion]{Digresión}
\newtheorem{ejemplox}[proposicion]{Ejemplo}
\newenvironment{ejemplo}
  {\pushQED{\qed}\renewcommand{\qedsymbol}{\examplesymbol}\ejemplox}
  {\popQED\endejemplox}
\newtheorem{contraejemplox}[proposicion]{Contraejemplo}
\newenvironment{contraejemplo}
  {\pushQED{\qed}\renewcommand{\qedsymbol}{\examplesymbol}\contraejemplox}
  {\popQED\endcontraejemplox}
\newtheorem{noejemplox}[proposicion]{No-ejemplo}
\newenvironment{noejemplo}
  {\pushQED{\qed}\renewcommand{\qedsymbol}{\examplesymbol}\noejemplox}
  {\popQED\endnoejemplox}
 
\newtheorem{ejemploastx}[proposicion]{Ejemplo ($\clubsuit$)}
\newenvironment{ejemploast}
  {\pushQED{\qed}\renewcommand{\qedsymbol}{\examplesymbol}\ejemploastx}
  {\popQED\endejemploastx}

\ifdefined\exercisespersection
  \theoremstyle{sectionexercise}
  \newtheorem{ejercicio}{}[section]
  \theoremstyle{mydefinition}
\else
  \ifdefined\exercisesglobal
    \theoremstyle{sectionexercise}
    \newtheorem{ejercicio}{}
    \theoremstyle{mydefinition}
  \else
    \ifdefined\exercisespersection
      \newtheorem{ejercicio}[proposicion]{Ejercicio}
    \fi
  \fi
\fi

% % % % % % % % % % % % % % % % % % % % % % % % % % % % % %

\theoremstyle{myplain}
\newtheorem{proposition}{Proposition}[section]
\newtheorem*{fact*}{Fact}
\newtheorem*{proposition*}{Proposition}
\newtheorem{lemma}[proposition]{Lemma}
\newtheorem*{lemma*}{Lemma}

\newtheorem{exercise}{Exercise}
\newtheorem*{hint}{Hint}

\newtheorem{theorem}[proposition]{Theorem}
\newtheorem{conjecture}[proposition]{Conjecture}
\newtheorem*{theorem*}{Theorem}
\newtheorem{corollary}[proposition]{Corollary}
\newtheorem{fact}[proposition]{Fact}
\newtheorem*{claim}{Claim}
\newtheorem{definition-theorem}[proposition]{Definition-theorem}

\theoremstyle{mydefinition}
\newtheorem{examplex}[proposition]{Example}
\newenvironment{example}
  {\pushQED{\qed}\renewcommand{\qedsymbol}{\examplesymbol}\examplex}
  {\popQED\endexamplex}

\newtheorem*{examplexx}{Example}
\newenvironment{example*}
  {\pushQED{\qed}\renewcommand{\qedsymbol}{\examplesymbol}\examplexx}
  {\popQED\endexamplexx}

\newtheorem{definition}[proposition]{Definition}
\newtheorem*{definition*}{Definition}
\newtheorem{wrong-definition}[proposition]{Wrong definition}
\newtheorem{remark}[proposition]{Remark}

\makeatletter
\newcommand{\xRightarrow}[2][]{\ext@arrow 0359\Rightarrowfill@{#1}{#2}}
\makeatother

% % % % % % % % % % % % % % % % % % % % % % % % % % % % % %

\newcommand{\Et}{\mathop{\text{\rm Ét}}}

\newcommand{\categ}[1]{\text{\bf #1}}
\newcommand{\vcateg}{\mathcal}
\newcommand{\bone}{{\boldsymbol 1}}
\newcommand{\bDelta}{{\boldsymbol\Delta}}
\newcommand{\bR}{{\mathbf{R}}}

\newcommand{\univ}{\mathfrak}

\newcommand{\TODO}{\colorbox{red}{\textbf{*** TODO ***}}}
\newcommand{\proofreadme}{\colorbox{red}{\textbf{*** NEEDS PROOFREADING ***}}}

\makeatletter
\def\iddots{\mathinner{\mkern1mu\raise\p@
\vbox{\kern7\p@\hbox{.}}\mkern2mu
\raise4\p@\hbox{.}\mkern2mu\raise7\p@\hbox{.}\mkern1mu}}
\makeatother

\newcommand{\ssincl}{\reflectbox{\rotatebox[origin=c]{45}{$\subseteq$}}}
\newcommand{\vsupseteq}{\reflectbox{\rotatebox[origin=c]{-90}{$\supseteq$}}}
\newcommand{\vin}{\reflectbox{\rotatebox[origin=c]{90}{$\in$}}}

\newcommand{\Ga}{\mathbb{G}_\mathrm{a}}
\newcommand{\Gm}{\mathbb{G}_\mathrm{m}}

\renewcommand{\U}{\UUU}

\DeclareRobustCommand{\Stirling}{\genfrac\{\}{0pt}{}}
\DeclareRobustCommand{\stirling}{\genfrac[]{0pt}{}}

% % % % % % % % % % % % % % % % % % % % % % % % % % % % % %
% tikz

\usepackage{tikz-cd}
\usetikzlibrary{babel}
\usetikzlibrary{decorations.pathmorphing}
\usetikzlibrary{arrows}
\usetikzlibrary{calc}
\usetikzlibrary{fit}
\usetikzlibrary{hobby}

% % % % % % % % % % % % % % % % % % % % % % % % % % % % % %
% Banners

\newcommand\mybannerext[3]{{\normalfont\sffamily\bfseries\large\noindent #1

\noindent #2

\noindent #3

}\noindent\rule{\textwidth}{1.25pt}

\vspace{1em}}

\newcommand\mybanner[2]{{\normalfont\sffamily\bfseries\large\noindent #1

\noindent #2

}\noindent\rule{\textwidth}{1.25pt}

\vspace{1em}}

\renewcommand{\O}{\mathcal{O}}
